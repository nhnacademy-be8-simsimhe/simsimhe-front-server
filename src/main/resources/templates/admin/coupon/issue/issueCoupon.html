<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>쿠폰 발급</title>
    <style>
        /* 기존 스타일 유지 */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        .container {
            max-width: 800px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .button-row {
            margin-top: 16px;
            text-align: right;
        }
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            background-color: #28a745;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .error {
            color: red;
            margin: 8px 0;
        }
        .success {
            color: green;
            margin: 8px 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>쿠폰 발급 - 유저 목록에서 선택</h1>
    <p>아래 유저 목록 중, 쿠폰을 발급할 유저들을 선택하세요. (중복 체크 포함)</p>

    <!-- 쿠폰 타입 이름 표시 (옵션) -->
    <p>발급할 쿠폰 타입: <strong th:text="${couponTypeName}">쿠폰 타입</strong></p>

    <!-- 월별 필터링 폼 (GET) -->
    <form th:action="@{/admin/coupons/issue}" method="get" id="filterForm">
        <input type="hidden" name="couponTypeId" th:value="${issueCouponsRequestDto.couponTypeId}" />
        <input type="hidden" name="couponTypeName" th:value="${couponTypeName}" />
        <label for="birthMonth">생일 월:</label>
        <select name="birthMonth" id="birthMonth">
            <option value="">전체</option>
            <option th:each="month : ${#numbers.sequence(1,12)}"
                    th:value="${month}"
                    th:text="${month} + '월'"
                    th:selected="${selectedBirthMonth != null} ? (${selectedBirthMonth} == ${month}) : false"></option>
        </select>
        <button type="submit">필터링</button>
    </form>

    <!--
      userList: List<UserResponse> (ACTIVE 사용자 등)
      issueCouponsRequestDto: IssueCouponsRequestDto (폼 바인딩)
    -->
    <form th:action="@{/admin/coupons/issue}"
          method="post"
          th:object="${issueCouponsRequestDto}"
          id="issueCouponForm">

        <!-- 쿠폰 타입 ID를 히든으로 전송 (필수) -->
        <input type="hidden" th:field="*{couponTypeId}" />

        <!-- 유저 목록 테이블 -->
        <table>
            <thead>
            <tr>
                <th>
                    <!-- 전체 선택 체크박스 -->
                    <input type="checkbox" id="selectAll" />
                </th>
                <th>ID</th>
                <th>이름</th>
                <th>이메일</th>
                <th>생일</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${userList}">
                <td>
                    <!-- 체크박스 th:field="*{userIds}"는 리스트 바인딩을 지원 -->
                    <input type="checkbox"
                           th:field="*{userIds}"
                           th:value="${user.userId}"
                           class="userCheckbox"
                           onclick="handleCheck(this)" />
                </td>
                <td th:text="${user.userId}">1</td>
                <td th:text="${user.userName}">홍길동</td>
                <td th:text="${user.email}">hong@xxx.com</td>
                <td th:text="${user.birth}">1990-01-01</td>
            </tr>
            <tr th:if="${#lists.isEmpty(userList)}">
                <td colspan="5">표시할 유저가 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 유효성 검증 오류 메시지 표시 -->
        <div class="error" th:if="${#fields.hasErrors()}"
             th:each="err : ${#fields.errors('*')}"
             th:text="${err}"></div>

        <div class="button-row">
            <button type="submit" onclick="return validateSelection()">발급하기</button>
        </div>
    </form>
</div>

<script>
    // 전체 선택 체크박스 제어
    document.getElementById('selectAll').addEventListener('change', function() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.userCheckbox');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = isChecked;
        });
    });

    // 개별 체크박스 제어 시 전체 선택 체크박스 상태 업데이트
    function handleCheck(checkbox) {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.userCheckbox');
        const total = checkboxes.length;
        const checked = document.querySelectorAll('.userCheckbox:checked').length;

        if (checked === total) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (checked > 0) {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }

        // 중복 체크 로직 (필요 시 구현)
        const userId = checkbox.value;
        const sameUserCheckboxes = document.querySelectorAll(`input[name="userIds"][value="${userId}"]`);
        if (sameUserCheckboxes.length > 1) {
            alert("중복된 유저 ID가 존재합니다.");
            checkbox.checked = false;
        }
    }

    // submit 시 "적어도 한명" 체크 여부
    function validateSelection() {
        const checkedBoxes = document.querySelectorAll('.userCheckbox:checked');
        if (checkedBoxes.length === 0) {
            alert("쿠폰을 발급할 유저를 최소 한 명 이상 선택해주세요.");
            return false; // 폼 제출 방지
        }
        return true; // 폼 제출 허용
    }
</script>
</body>
</html>
